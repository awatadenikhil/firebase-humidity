<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Weather Data Graph and Table</title>

  <!-- Load jQuery and Plotly -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.plot.ly/plotly-3.0.1.min.js"></script>

  <style>
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }
    th, td {
      padding: 8px;
      border: 1px solid #ccc;
      text-align: center;
    }
    th {
      background-color: #f2f2f2;
    }
    .pagination {
      margin-top: 10px;
      text-align: center;
    }
    .pagination button {
      padding: 5px 10px;
      margin: 0 5px;
    }
  </style>
</head>
<body>
  <h1>Room Humidity</h1>

  <!-- Plotly chart -->
  <div id="myDiv"></div>

  <!-- Table for weather data -->
  <table id="weatherTable">
    <thead>
      <tr>
        <th>Date Time</th>
        <th>Temperature (°C)</th>
        <th>Humidity (%)</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <!-- Pagination controls -->
  <div class="pagination">
    <button id="prevPage">Previous</button>
    <span id="pageInfo"></span>
    <button id="nextPage">Next</button>
  </div>

  <script>
    const recordsPerPage = 20;
    let weatherData = [];
    let currentPage = 1;

    function fetchWeatherData() {
      $.get('https://fir-humidity-8c9c7-default-rtdb.firebaseio.com/humidityInfo.json')
        .done(function(data) {
          if (!data) {
            alert("No data received from API");
            return;
          }

          const dataArray = Object.values(data);

          // Sort for graph (ascending)
          dataArray.sort((a, b) => new Date(a.DateTime) - new Date(b.DateTime));

          // Plot graph
          const times = dataArray.map(item => item.DateTime);
          const temperatures = dataArray.map(item => item.Temperature);
          const humidity = dataArray.map(item => item.Humidity);

          const trace1 = {
            x: times,
            y: temperatures,
            type: 'scatter',
            mode: 'lines+markers',
            name: 'Temperature (°C)',
            marker: { color: 'red' }
          };

          const trace2 = {
            x: times,
            y: humidity,
            type: 'scatter',
            mode: 'lines+markers',
            name: 'Humidity (%)',
            marker: { color: 'blue' }
          };

          const layout = {
            title: 'Weather Data (Temperature and Humidity)',
            xaxis: { title: 'Time' },
            yaxis: { title: 'Value' }
          };

          Plotly.newPlot('myDiv', [trace1, trace2], layout);

          // Sort for table (descending)
          weatherData = [...dataArray].sort((a, b) => new Date(b.DateTime) - new Date(a.DateTime));
          currentPage = 1;
          renderTablePage();
        })
        .fail(function() {
          alert("Failed to load weather data.");
        });
    }

    function renderTablePage() {
      const tbody = $('#weatherTable tbody');
      tbody.empty();

      const start = (currentPage - 1) * recordsPerPage;
      const end = Math.min(start + recordsPerPage, weatherData.length);
      const pageData = weatherData.slice(start, end);

      pageData.forEach(item => {
        const row = `<tr>
          <td>${item.DateTime}</td>
          <td>${item.Temperature}</td>
          <td>${item.Humidity}</td>
        </tr>`;
        tbody.append(row);
      });

      $('#pageInfo').text(`Page ${currentPage} of ${Math.ceil(weatherData.length / recordsPerPage)}`);
      $('#prevPage').prop('disabled', currentPage === 1);
      $('#nextPage').prop('disabled', end >= weatherData.length);
    }

    // Pagination button events
    $('#prevPage').click(() => {
      if (currentPage > 1) {
        currentPage--;
        renderTablePage();
      }
    });

    $('#nextPage').click(() => {
      if ((currentPage * recordsPerPage) < weatherData.length) {
        currentPage++;
        renderTablePage();
      }
    });

    // Initial fetch
    fetchWeatherData();

    // Optional: auto-refresh every minute
    setInterval(fetchWeatherData, 60000);
  </script>
</body>
</html>
